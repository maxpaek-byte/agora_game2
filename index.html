<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SNAKE GAME</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --bg:#07070d;--surface:#101018;--border:#1c1c2e;
    --accent:#6ee7b7;--accent-dim:rgba(52,211,153,0.12);--accent-glow:rgba(110,231,183,0.25);
    --text:#e2e8f0;--text-dim:#64748b;
    --error:#f87171;--error-glow:rgba(248,113,113,0.25);
    --gold:#fbbf24;--tile:#161626;--tile-hover:#222238;
  }
  body{
    min-height:100vh;background:var(--bg);
    display:flex;align-items:center;justify-content:center;
    font-family:'JetBrains Mono','Fira Code',monospace;color:var(--text);
    overflow:hidden;
  }
  .bg-glow{
    position:fixed;inset:0;pointer-events:none;
    background:
      radial-gradient(ellipse at 15% 50%,rgba(110,231,183,0.07),transparent 55%),
      radial-gradient(ellipse at 85% 20%,rgba(139,92,246,0.06),transparent 50%);
    animation:glowPulse 5s ease-in-out infinite alternate;
  }
  @keyframes glowPulse{0%{opacity:.6}100%{opacity:1}}

  .app{position:relative;z-index:1;width:100%;max-width:440px;padding:20px;display:flex;flex-direction:column;align-items:center;gap:22px}

  /* Title */
  .title{
    font-family:'Space Grotesk',sans-serif;font-size:30px;font-weight:700;
    letter-spacing:-0.5px;
    background:linear-gradient(135deg,var(--accent),#a78bfa);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  }
  .subtitle{font-size:11px;color:var(--text-dim);letter-spacing:3px;text-transform:uppercase;margin-top:2px}

  /* Stats bar */
  .stats{
    display:flex;justify-content:space-between;width:100%;
    padding:14px 18px;background:var(--surface);border-radius:14px;
    border:1px solid var(--border);animation:fadeUp .4s ease-out;
  }
  .stat{text-align:center;flex:1}
  .stat-label{font-size:9px;color:var(--text-dim);letter-spacing:1.5px;margin-bottom:3px}
  .stat-value{font-size:20px;font-weight:700}
  .stat-value.accent{color:var(--accent)}
  .stat-value.gold{color:var(--gold)}
  .stat-value.dim{color:var(--text-dim)}

  /* Canvas */
  canvas{
    border-radius:14px;border:1.5px solid var(--border);
    background:var(--tile);display:block;
    image-rendering:pixelated;
  }

  /* Panels */
  .panel{
    text-align:center;padding:44px 28px;background:var(--surface);
    border-radius:18px;border:1px solid var(--border);width:100%;
    animation:fadeUp .6s ease-out;
  }
  .panel-icon{font-size:52px;margin-bottom:14px;animation:float 2.2s ease-in-out infinite}
  .panel-title{font-family:'Space Grotesk',sans-serif;font-size:21px;font-weight:700;margin-bottom:6px}
  .panel-desc{font-size:13px;color:var(--text-dim);line-height:1.7;margin-bottom:28px}

  .btn{
    padding:14px 48px;border-radius:11px;border:none;
    background:linear-gradient(135deg,var(--accent),#a78bfa);
    color:var(--bg);font-size:15px;font-weight:700;
    font-family:'Space Grotesk',sans-serif;cursor:pointer;
    letter-spacing:1px;transition:transform .2s,box-shadow .2s;
    box-shadow:0 4px 22px var(--accent-glow);
  }
  .btn:hover{transform:translateY(-2px);box-shadow:0 8px 32px var(--accent-glow)}
  .btn:active{transform:translateY(0)}

  /* Result row */
  .result-row{display:flex;justify-content:center;gap:36px;margin-bottom:26px}
  .result-item .result-label{font-size:10px;color:var(--text-dim);letter-spacing:1.5px}
  .result-item .result-val{font-size:30px;font-weight:700}

  .best-score{font-size:12px;color:var(--text-dim)}
  .best-score span{color:var(--gold);font-weight:600}

  /* D-pad */
  .dpad{display:grid;grid-template-columns:repeat(3,56px);grid-template-rows:repeat(3,56px);gap:6px;margin-top:4px}
  .dpad-btn{
    border-radius:11px;border:1.5px solid var(--border);background:var(--surface);
    color:var(--text);font-size:20px;cursor:pointer;
    display:flex;align-items:center;justify-content:center;
    transition:all .15s;user-select:none;-webkit-user-select:none;
  }
  .dpad-btn:active{background:var(--accent-dim);border-color:var(--accent);transform:scale(.92)}
  .dpad-blank{visibility:hidden}

  /* Name input */
  .name-row{display:flex;gap:8px;width:100%;margin-bottom:8px}
  .name-input{
    flex:1;padding:10px 14px;border-radius:10px;border:1.5px solid var(--border);
    background:var(--surface);color:var(--text);font-family:'JetBrains Mono',monospace;
    font-size:13px;outline:none;transition:border-color .2s;
  }
  .name-input:focus{border-color:var(--accent)}
  .name-input::placeholder{color:var(--text-dim)}

  /* Leaderboard */
  .leaderboard{
    width:100%;background:var(--surface);border-radius:14px;
    border:1px solid var(--border);overflow:hidden;animation:fadeUp .5s ease-out;
  }
  .lb-header{
    padding:12px 16px;font-family:'Space Grotesk',sans-serif;
    font-size:13px;font-weight:700;letter-spacing:1px;color:var(--accent);
    border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;
  }
  .lb-row{
    display:flex;align-items:center;padding:9px 16px;
    border-bottom:1px solid rgba(28,28,46,0.5);font-size:12px;transition:background .15s;
  }
  .lb-row:last-child{border-bottom:none}
  .lb-row:hover{background:var(--accent-dim)}
  .lb-row.me{background:rgba(110,231,183,0.06)}
  .lb-rank{width:28px;font-weight:700;color:var(--text-dim)}
  .lb-rank.top1{color:var(--gold)}
  .lb-rank.top2{color:#c0c0c0}
  .lb-rank.top3{color:#cd7f32}
  .lb-name{flex:1;color:var(--text);font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .lb-score{width:60px;text-align:right;color:var(--accent);font-weight:700}
  .lb-len{width:40px;text-align:right;color:var(--text-dim)}
  .lb-date{width:70px;text-align:right;color:var(--text-dim);font-size:10px}
  .lb-empty{padding:20px;text-align:center;color:var(--text-dim);font-size:12px}
  .lb-loading{padding:20px;text-align:center;color:var(--text-dim);font-size:12px}
  .saving-msg{font-size:11px;color:var(--text-dim);margin-top:6px;animation:fadeUp .3s}

  /* Animations */
  @keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
  @keyframes slideDown{from{opacity:0;transform:translateY(-24px) scale(.85)}to{opacity:1;transform:translateY(0) scale(1)}}
</style>
</head>
<body>
<div class="bg-glow"></div>
<div class="app" id="app"></div>

<script>
const $ = s => document.querySelector(s);
const COLS = 20, ROWS = 20, CELL = 17;

/* â”€â”€ Supabase â”€â”€ */
const SUPABASE_URL = 'https://zwifavxiicgirieolbon.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3aWZhdnhpaWNnaXJpZW9sYm9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNTg2MzEsImV4cCI6MjA4NjgzNDYzMX0.3gjdIf2LLUtaDpfxYX19NS7no380YaiLG5aekAhzITQ';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* â”€â”€ Game State â”€â”€ */
let state = 'idle', score = 0, bestScore = 0, speed = 150;
let snake, dir, nextDir, food, loop;
let playerName = localStorage.getItem('snake_player_name') || '';
let leaderboard = [];
let lbLoading = false;
let savingScore = false;

/* â”€â”€ Leaderboard Functions â”€â”€ */
async function fetchLeaderboard() {
  lbLoading = true;
  renderLeaderboard();
  try {
    const { data, error } = await supabase
      .from('scores')
      .select('*')
      .order('score', { ascending: false })
      .limit(10);
    if (error) throw error;
    leaderboard = data || [];
  } catch (e) {
    console.error('ë¦¬ë”ë³´ë“œ ë¡œë”© ì‹¤íŒ¨:', e);
    leaderboard = [];
  }
  lbLoading = false;
  renderLeaderboard();
}

async function saveScore(name, sc, len) {
  savingScore = true;
  render();
  try {
    const { error } = await supabase
      .from('scores')
      .insert([{ player_name: name, score: sc, snake_length: len }]);
    if (error) throw error;
  } catch (e) {
    console.error('ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨:', e);
  }
  savingScore = false;
  await fetchLeaderboard();
}

function formatDate(dateStr) {
  const d = new Date(dateStr);
  return `${d.getMonth() + 1}/${d.getDate()}`;
}

function leaderboardHTML() {
  if (lbLoading) return `<div class="leaderboard"><div class="lb-header">ğŸ† ë¦¬ë”ë³´ë“œ</div><div class="lb-loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>`;
  if (leaderboard.length === 0) return `<div class="leaderboard"><div class="lb-header">ğŸ† ë¦¬ë”ë³´ë“œ</div><div class="lb-empty">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div></div>`;
  let rows = '';
  leaderboard.forEach((r, i) => {
    const rankClass = i === 0 ? 'top1' : i === 1 ? 'top2' : i === 2 ? 'top3' : '';
    const medal = i === 0 ? 'ğŸ‘‘' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i + 1}`;
    const isMe = r.player_name === playerName;
    rows += `<div class="lb-row${isMe ? ' me' : ''}">
      <div class="lb-rank ${rankClass}">${medal}</div>
      <div class="lb-name">${r.player_name}</div>
      <div class="lb-score">${r.score}</div>
      <div class="lb-len">Ã—${r.snake_length}</div>
      <div class="lb-date">${formatDate(r.created_at)}</div>
    </div>`;
  });
  return `<div class="leaderboard"><div class="lb-header">ğŸ† ë¦¬ë”ë³´ë“œ</div>${rows}</div>`;
}

function renderLeaderboard() {
  const el = document.getElementById('leaderboard-area');
  if (el) el.innerHTML = leaderboardHTML();
}

/* â”€â”€ Player Name â”€â”€ */
function updateName(val) {
  playerName = val.trim();
  localStorage.setItem('snake_player_name', playerName);
}

/* â”€â”€ Render â”€â”€ */
function render() {
  const app = $('#app');
  let html = `
    <div style="text-align:center">
      <div class="title">SNAKE GAME</div>
      <div class="subtitle">ë±€ì„ ì¡°ì¢…í•˜ì„¸ìš”</div>
    </div>`;

  if (state === 'idle') {
    html += `
      <div class="panel">
        <div class="panel-icon">ğŸ</div>
        <div class="panel-title">ë±€ ê²Œì„</div>
        <div class="panel-desc">ë°©í–¥í‚¤ë¡œ ë±€ì„ ì›€ì§ì—¬<br>ë¨¹ì´ë¥¼ ë¨¹ê³  ì ìˆ˜ë¥¼ ì˜¬ë¦¬ì„¸ìš”!</div>
        <div class="name-row">
          <input class="name-input" id="nameInput" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20" value="${playerName}" oninput="updateName(this.value)">
        </div>
        <button class="btn" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
      </div>`;
    if (bestScore > 0) html += `<div class="best-score">ìµœê³  ì ìˆ˜: <span>${bestScore}</span></div>`;
    html += `<div id="leaderboard-area">${leaderboardHTML()}</div>`;
  }
  else if (state === 'gameover') {
    html += `
      <div class="panel">
        <div class="panel-icon">ğŸ’€</div>
        <div class="panel-title">ê²Œì„ ì˜¤ë²„</div>
        <div class="result-row">
          <div class="result-item"><div class="result-label">SCORE</div><div class="result-val" style="color:var(--accent)">${score}</div></div>
          <div class="result-item"><div class="result-label">BEST</div><div class="result-val" style="color:var(--gold)">${bestScore}</div></div>
          <div class="result-item"><div class="result-label">LENGTH</div><div class="result-val">${snake.length}</div></div>
        </div>
        ${savingScore ? '<div class="saving-msg">ì ìˆ˜ ì €ì¥ ì¤‘...</div>' : ''}
        <button class="btn" onclick="startGame()">ë‹¤ì‹œ ë„ì „</button>
      </div>`;
    html += `<div id="leaderboard-area">${leaderboardHTML()}</div>`;
  }
  else {
    html += `<div class="stats">
      <div class="stat"><div class="stat-label">SCORE</div><div class="stat-value accent">${score}</div></div>
      <div class="stat"><div class="stat-label">LENGTH</div><div class="stat-value">${snake.length}</div></div>
      <div class="stat"><div class="stat-label">SPEED</div><div class="stat-value ${speed <= 80 ? 'gold' : 'dim'}">${Math.round((200 - speed) / 10)}</div></div>
      <div class="stat"><div class="stat-label">BEST</div><div class="stat-value gold">${bestScore}</div></div>
    </div>`;
    html += `<canvas id="canvas" width="${COLS * CELL}" height="${ROWS * CELL}"></canvas>`;
    html += `
    <div class="dpad">
      <div class="dpad-blank"></div>
      <div class="dpad-btn" ontouchstart="setDir(0,-1);event.preventDefault()" onclick="setDir(0,-1)">â–²</div>
      <div class="dpad-blank"></div>
      <div class="dpad-btn" ontouchstart="setDir(-1,0);event.preventDefault()" onclick="setDir(-1,0)">â—€</div>
      <div class="dpad-blank"></div>
      <div class="dpad-btn" ontouchstart="setDir(1,0);event.preventDefault()" onclick="setDir(1,0)">â–¶</div>
      <div class="dpad-blank"></div>
      <div class="dpad-btn" ontouchstart="setDir(0,1);event.preventDefault()" onclick="setDir(0,1)">â–¼</div>
      <div class="dpad-blank"></div>
    </div>`;
  }
  app.innerHTML = html;
  if (state === 'playing') drawCanvas();
}

function drawCanvas() {
  const cv = $('#canvas');
  if (!cv) return;
  const ctx = cv.getContext('2d');
  ctx.clearRect(0, 0, cv.width, cv.height);

  // Grid lines
  ctx.strokeStyle = '#1c1c2e';
  ctx.lineWidth = 0.5;
  for (let x = 0; x <= COLS; x++) {
    ctx.beginPath(); ctx.moveTo(x * CELL, 0); ctx.lineTo(x * CELL, ROWS * CELL); ctx.stroke();
  }
  for (let y = 0; y <= ROWS; y++) {
    ctx.beginPath(); ctx.moveTo(0, y * CELL); ctx.lineTo(COLS * CELL, y * CELL); ctx.stroke();
  }

  // Food
  ctx.fillStyle = '#f87171';
  ctx.shadowColor = 'rgba(248,113,113,0.5)';
  ctx.shadowBlur = 10;
  ctx.beginPath();
  ctx.arc(food.x * CELL + CELL / 2, food.y * CELL + CELL / 2, CELL / 2.5, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;

  // Snake
  snake.forEach((seg, idx) => {
    const isHead = idx === 0;
    const t = idx / snake.length;
    const r = Math.round(110 - t * 60);
    const g = Math.round(231 - t * 80);
    const b = Math.round(183 - t * 60);
    ctx.fillStyle = `rgb(${r},${g},${b})`;
    if (isHead) {
      ctx.shadowColor = 'rgba(110,231,183,0.4)';
      ctx.shadowBlur = 12;
    }
    const pad = isHead ? 0.5 : 1;
    ctx.beginPath();
    ctx.roundRect(seg.x * CELL + pad, seg.y * CELL + pad, CELL - pad * 2, CELL - pad * 2, 4);
    ctx.fill();
    ctx.shadowBlur = 0;
  });
}

function spawnFood() {
  const occupied = new Set(snake.map(s => `${s.x},${s.y}`));
  let fx, fy;
  do {
    fx = Math.floor(Math.random() * COLS);
    fy = Math.floor(Math.random() * ROWS);
  } while (occupied.has(`${fx},${fy}`));
  food = { x: fx, y: fy };
}

function startGame() {
  const nameEl = document.getElementById('nameInput');
  if (nameEl) updateName(nameEl.value);
  if (!playerName) playerName = 'ìµëª…';
  score = 0;
  speed = 150;
  snake = [{ x: 10, y: 10 }, { x: 9, y: 10 }, { x: 8, y: 10 }];
  dir = { x: 1, y: 0 };
  nextDir = { x: 1, y: 0 };
  spawnFood();
  state = 'playing';
  render();
  clearInterval(loop);
  loop = setInterval(tick, speed);
}

function setDir(dx, dy) {
  if (dir.x + dx === 0 && dir.y + dy === 0) return;
  nextDir = { x: dx, y: dy };
}

function tick() {
  dir = { ...nextDir };
  const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };

  // Wall collision
  if (head.x < 0 || head.x >= COLS || head.y < 0 || head.y >= ROWS) {
    return gameOver();
  }
  // Self collision
  if (snake.some(s => s.x === head.x && s.y === head.y)) {
    return gameOver();
  }

  snake.unshift(head);

  if (head.x === food.x && head.y === food.y) {
    score += 10;
    if (score > bestScore) bestScore = score;
    if (speed > 60) {
      speed -= 3;
      clearInterval(loop);
      loop = setInterval(tick, speed);
    }
    spawnFood();
  } else {
    snake.pop();
  }
  render();
}

function gameOver() {
  clearInterval(loop);
  state = 'gameover';
  render();
  saveScore(playerName || 'ìµëª…', score, snake.length);
}

document.addEventListener('keydown', e => {
  if (state === 'idle' || state === 'gameover') {
    if (e.key === 'Enter' || e.key === ' ') { startGame(); e.preventDefault(); }
    return;
  }
  if (state !== 'playing') return;
  switch (e.key) {
    case 'ArrowUp':    case 'w': case 'W': setDir(0, -1); break;
    case 'ArrowDown':  case 's': case 'S': setDir(0, 1); break;
    case 'ArrowLeft':  case 'a': case 'A': setDir(-1, 0); break;
    case 'ArrowRight': case 'd': case 'D': setDir(1, 0); break;
  }
  e.preventDefault();
});

/* â”€â”€ Init â”€â”€ */
fetchLeaderboard();
render();
</script>
</body>
</html>
